<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <title>Unjuran Jadual Waktu 2026</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #333; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    .header-utama { background:#f59e0b; color:#fff; font-weight:bold; }
    .subhead-utama { background:#ffedd5; font-weight:bold; }
    .bord-utama th, .bord-utama td { border:2px solid #f59e0b; }
    .wrapper-scroll { max-height: 520px; overflow: auto; border:2px solid #f59e0b; border-radius:6px; }
    .wrapper-scroll thead th { position: sticky; top: 0; z-index: 2; }
    .tingkatan-row td { background:#fde68a; font-weight:bold; text-align:left; }
    .btn { padding:6px 10px; border:1px solid #333; background:#f4f4f4; cursor:pointer; border-radius:4px; }
    .btn:hover { background:#e9e9e9; }
    .table-simple { border-collapse: collapse; width:100%; margin-top:10px; }
    .table-simple th, .table-simple td { border:1px solid #333; padding:6px; text-align:center; }
    .table-simple th { background:#fafafa; }
    .input-sm { padding:6px; width:100%; box-sizing:border-box; }
    .wrapper-scroll-sm { max-height: 360px; overflow: auto; border:2px solid #f59e0b; border-radius:6px; }
    .wrapper-scroll-sm thead th { position: sticky; top: 0; z-index: 2; background:#fafafa; }
    .col-sing { white-space: nowrap; width:1%; }
    .in-sing { width: 110px; box-sizing: border-box; }
    .in-subj-name, .in-subj-sing { width: 100%; box-sizing: border-box; padding:6px; }
    .col-sub { white-space: nowrap; width:1%; }
    .in-sub { width: 70px; box-sizing: border-box; }
    .row-forms { display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    .row-forms .col { flex:1 1 420px; min-width:360px; }
    .card { padding:8px; border-radius:8px; border:2px solid #ddd; }
    .table-colored tbody tr:nth-child(even) { background:#f8fafc; }
    .table-guru th { background:#2563eb; color:#fff; }
    .table-subjek th { background:#059669; color:#fff; }
    .table-guru th, .table-guru td { border-color:#1e40af; }
    .table-subjek th, .table-subjek td { border-color:#065f46; }
    .wrapper-scroll-sm.theme-guru { border-color:#2563eb; }
    .wrapper-scroll-sm.theme-subjek { border-color:#059669; }
    .wrapper-scroll-sm.theme-guru thead th { background:#2563eb; color:#fff; }
    .wrapper-scroll-sm.theme-subjek thead th { background:#059669; color:#fff; }
    .app-header { position: sticky; top: 0; z-index: 10; background: linear-gradient(90deg,#1e3a8a,#1d4ed8); color:#fff; padding:14px 16px; border-radius:8px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
    .app-header h1 { margin:0; font-size:22px; letter-spacing:0.3px; }
    .app-header p { margin:2px 0 0 0; opacity:0.95; }
    /* status bar */
    #status { margin:10px 0; padding:8px 10px; border-radius:6px; display:none; }
    #status.ok { background:#ecfdf5; border:1px solid #10b981; color:#065f46; display:block; }
    #status.warn { background:#fff7ed; border:1px solid #fb923c; color:#7c2d12; display:block; }
    #status.err { background:#fef2f2; border:1px solid #ef4444; color:#7f1d1d; display:block; }
    #status small { opacity:.85 }
  </style>
</head>
<body>
  <div class="app-header">
    <h1 id="mainHeaderTitle">Unjuran Jadual Waktu 2026</h1>
    <p id="mainHeaderSub">SMK Dato' Usman Awang</p>
  </div>

  <div id="status"></div>

  <div style="margin:10px 0;">
    <button type="button" class="btn" onclick="resetLocalData()">Reset Data Tempatan</button>
    <button type="button" class="btn" onclick="syncToServer()">Sync ke Google Sheets</button>
    <button type="button" class="btn" onclick="fetchFromServer()">Refresh dari Google Sheets</button>
  </div>

  <div class="row-forms">
    <div class="col card">
      <h2>Pengisian Nama Guru</h2>
      <div>
        <input type="text" id="guruNama" placeholder="Nama penuh (cth: JASLEY A/P ...)" style="text-transform:uppercase; width:48%" />
        <input type="text" id="guruSing" placeholder="Singkatan (cth: JASLEY)" style="text-transform:uppercase; width:25%" />
        <button type="button" class="btn" onclick="addTeacher()">Tambah Guru</button>
      </div>
      <div class="wrapper-scroll-sm theme-guru" style="margin-top:8px;">
        <table id="tblGuru" class="table-simple table-colored table-guru"></table>
      </div>
      <div style="margin-top:10px;">
        <details>
          <summary style="cursor:pointer">Import Pukal Guru</summary>
          <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start;">
            <textarea id="bulkGuruText" placeholder="Satu baris satu guru. Format sokongan:
- Nama penuh sahaja
- Nama penuh, SING
- SING - Nama penuh" style="width:100%; max-width:560px; height:120px; text-transform:uppercase"></textarea>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <button type="button" class="btn" onclick="importGuruBulk()">Import</button>
              <button type="button" class="btn" onclick="exportGuruCSV()">Eksport CSV</button>
            </div>
            <small>Contoh: "AHMAD BIN ALI, AHMAD" atau "AHMAD - AHMAD" atau hanya "AHMAD BIN ALI"</small>
          </div>
        </details>
      </div>
    </div>

    <div class="col card">
      <h2>Senarai Subjek & Singkatan</h2>
      <div>
        <input type="text" id="subjNama" placeholder="Nama subjek penuh" style="text-transform:uppercase; width:40%" />
        <input type="text" id="subjSing" placeholder="Singkatan" style="text-transform:uppercase; width:25%" />
        <button type="button" class="btn" onclick="addSubject()">Tambah Subjek</button>
      </div>
      <div class="wrapper-scroll-sm theme-subjek" style="margin-top:8px;">
        <table id="tblSubjects" class="table-simple table-colored table-subjek"></table>
      </div>
    </div>
  </div>

  <h2>Jadual Subjek Utama</h2>
  <div class="wrapper-scroll">
    <table id="jadualSubjekUtama" class="bord-utama"></table>
  </div>

  <h2>Rumusan Mengikut Guru</h2>
  <div id="output"></div>

<script>
  // === TETAPKAN WEB APP GAS URL DI SINI ===
  const API_URL = "PASTE_GOOGLE_APPS_SCRIPT_WEBAPP_URL_HERE"; // mesti /exec

  // util: panel status
  function notify(msg, type='ok'){
    const el = document.getElementById('status');
    if(!el) return;
    el.className = ''; el.textContent = '';
    el.classList.add(type==='ok'?'ok':type==='warn'?'warn':'err');
    el.innerHTML = msg;
  }

  let data = [];
  const TEACHERS = [];
  let SUBJECTS_ALL = [];

  const CLASS_CODES = ["BER","NIL","ZAM","RAF","HIB","LAV","DAH","AKA","TUL","ORK","IXO"];
  const PERALIHAN_CODES = ["P1","P2"];
  const TINGKATAN_ORDER = [5,4,3,2,1,"PERALIHAN"];
  const SUBJECTS_DEFAULT = ["BI","BM","MATEMATIK","SAINS","SEJARAH"];

  const LS_TEACHERS_KEY = 'rumusan_guru_teachers_v1';
  const LS_DATA_KEY     = 'rumusan_guru_data_v1';
  const LS_SUBJECTS_KEY = 'rumusan_guru_subjects_v1';

  // ========== LocalStorage ==========
  function saveState(){
    try{
      localStorage.setItem(LS_TEACHERS_KEY, JSON.stringify(TEACHERS));
      localStorage.setItem(LS_DATA_KEY, JSON.stringify(data));
      localStorage.setItem(LS_SUBJECTS_KEY, JSON.stringify(SUBJECTS_ALL));
    }catch(e){ console.warn(e); }
  }
  function loadState(){
    try{
      const t=JSON.parse(localStorage.getItem(LS_TEACHERS_KEY)||"[]");
      const d=JSON.parse(localStorage.getItem(LS_DATA_KEY)||"[]");
      const s=JSON.parse(localStorage.getItem(LS_SUBJECTS_KEY)||"[]");
      TEACHERS.length=0; t.forEach(x=>TEACHERS.push(x));
      data.length=0; d.forEach(x=>data.push(x));
      SUBJECTS_ALL.length=0; s.forEach(x=>SUBJECTS_ALL.push(x));
    }catch(e){ console.warn(e); }
  }
  function resetLocalData(){
    if(!confirm('Padam semua data tempatan (guru, subjek, jadual)?')) return;
    localStorage.removeItem(LS_TEACHERS_KEY);
    localStorage.removeItem(LS_DATA_KEY);
    localStorage.removeItem(LS_SUBJECTS_KEY);
    TEACHERS.length = 0; SUBJECTS_ALL.length = 0; data.length = 0;
    renderTeacherTable(); renderSubjects(); buildJadual(); paparRumusan();
    notify('Data tempatan dipadam.', 'warn');
  }

  // ========== Server Sync (GAS) ==========
  async function safeParseJSON(res){
    const text = await res.text();
    try { return { ok:true, json: JSON.parse(text) }; }
    catch { return { ok:false, text }; }
  }

  async function fetchFromServer(){
    if(!API_URL || API_URL.startsWith('PASTE_')){
      notify('API_URL belum ditetapkan. Tetapkan URL Web App GAS yang berakhir dengan <code>/exec</code>.', 'warn');
      return;
    }
    try{
      const res = await fetch(API_URL, { method:'GET', mode:'cors', credentials:'omit' });
      const parsed = await safeParseJSON(res);
      if(!res.ok){ notify(`Ralat HTTP ${res.status}. ${parsed.text||''}`, 'err'); return; }
      if(!parsed.ok){ notify('Server balas bukan JSON. Pratonton:<br><small>'+escapeHtml(parsed.text.slice(0,400))+'…</small>', 'err'); return; }
      const json = parsed.json;
      if(json.success){
        TEACHERS.length=0; (json.teachers||[]).forEach(t=>TEACHERS.push({ name:String(t.name||'').toUpperCase(), sing:String(t.sing||t.name||'').toUpperCase() }));
        SUBJECTS_ALL.length=0; (json.subjects||[]).forEach(s=>SUBJECTS_ALL.push({ name:String(s.name||'').toUpperCase(), sing:String(s.sing||s.name||'').toUpperCase() }));
        data.length=0; (json.jadual||[]).forEach(j=>data.push({
          tingkatan: (j.tingkatan===undefined||j.tingkatan===null)? '' : j.tingkatan,
          kelas: String(j.kelas||'').toUpperCase(),
          masa: Number(j.masa||0),
          subjek: String(j.subjek||'').toUpperCase(),
          guru: String(j.guru||'').toUpperCase(),
          confirmed: !!j.confirmed
        }));
        saveState(); renderTeacherTable(); renderSubjects(); buildJadual(); paparRumusan();
        notify('Data berjaya dimuat dari Google Sheets.', 'ok');
      } else {
        notify('Gagal ambil data: '+escapeHtml(json.error||'Tidak diketahui'), 'err');
      }
    }catch(e){
      console.error(e);
      notify('Ralat sambungan ke server: '+escapeHtml(String(e)), 'err');
    }
  }

  async function syncToServer(){
    if(!API_URL || API_URL.startsWith('PASTE_')){
      notify('Sila tetapkan API_URL (Web App GAS) dahulu.', 'warn');
      return;
    }
    try{
      const payload = { action:"write", teachers:TEACHERS, subjects:SUBJECTS_ALL, jadual:data };
      const res = await fetch(API_URL, {
        method:"POST",
        mode:'cors',
        credentials:'omit',
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const parsed = await safeParseJSON(res);
      if(!res.ok){ notify(`Ralat HTTP ${res.status}. ${parsed.text||''}`, 'err'); return; }
      if(!parsed.ok){ notify('Server balas bukan JSON. Pratonton:<br><small>'+escapeHtml(parsed.text.slice(0,400))+'…</small>', 'err'); return; }
      const json = parsed.json;
      if(json.success){
        notify('Data berjaya disimpan ke Google Sheets.', 'ok');
      } else {
        notify('Gagal simpan: '+escapeHtml(json.error||'Tidak diketahui'), 'err');
      }
    }catch(e){
      console.error(e);
      notify('Ralat sync ke server: '+escapeHtml(String(e)), 'err');
    }
  }

  // util kecil
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ========== GURU ==========
  function renderTeacherTable(){
    const tbl = document.getElementById('tblGuru');
    if(!tbl) return;
    let html = '<thead><tr><th>BIL</th><th>NAMA</th><th class="col-sing">SING</th><th>TINDAKAN</th></tr></thead><tbody>';
    if(TEACHERS.length===0){
      html += '<tr><td colspan="4">— Tiada nama guru —</td></tr>';
    } else {
      TEACHERS.forEach((t,i)=>{
        const nm = (t.name||'').toUpperCase();
        const sg = (t.sing||t.name||'').toUpperCase();
        html += `<tr>
          <td>${i+1}</td>
          <td><input class="input-sm in-nama" data-idx="${i}" value="${nm}" style="text-transform:uppercase" /></td>
          <td class="col-sing"><input class="input-sm in-sing" data-idx="${i}" value="${sg}" style="text-transform:uppercase" /></td>
          <td><button type="button" class="btn" onclick="removeTeacher(${i})">Padam</button></td>
        </tr>`;
      });
    }
    html += '</tbody>';
    tbl.innerHTML = html;
    tbl.querySelectorAll('.in-nama').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const idx = parseInt(inp.dataset.idx,10);
        if(Number.isFinite(idx) && TEACHERS[idx]){
          TEACHERS[idx].name = (inp.value||'').trim().toUpperCase();
          buildJadual(); paparRumusan(); saveState();
        }
      });
    });
    tbl.querySelectorAll('.in-sing').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const idx = parseInt(inp.dataset.idx,10);
        if(Number.isFinite(idx) && TEACHERS[idx]){
          TEACHERS[idx].sing = (inp.value||'').trim().toUpperCase();
          buildJadual(); paparRumusan(); saveState();
        }
      });
    });
  }
  function addTeacher(){
    const nInp = document.getElementById('guruNama');
    const sInp = document.getElementById('guruSing');
    const nama = (nInp.value||'').trim().toUpperCase();
    const sing = (sInp.value||'').trim().toUpperCase();
    if(!nama){ notify('Sila masukkan nama penuh guru.', 'warn'); return; }
    const exists = TEACHERS.some(t => t.name===nama || (sing && t.sing===sing));
    if(exists){ notify('Nama atau singkatan telah wujud.', 'warn'); return; }
    TEACHERS.push({ name: nama, sing: sing || nama });
    nInp.value = ''; sInp.value = '';
    renderTeacherTable(); buildJadual(); paparRumusan(); saveState();
  }
  function removeTeacher(idx){
    if(idx > -1 && idx < TEACHERS.length){
      TEACHERS.splice(idx,1);
      renderTeacherTable(); buildJadual(); paparRumusan(); saveState();
    }
  }
  function parseGuruLine(line){
    let s = String(line||'').trim();
    if(!s) return null;
    let name='', sing='';
    if(s.includes(',')){
      const [n, sg] = s.split(',');
      name = (n||'').trim(); sing = (sg||'').trim();
    } else if(s.includes(' - ')){
      const [sg, n] = s.split(' - ');
      name = (n||'').trim(); sing = (sg||'').trim();
    } else {
      name = s; sing = s;
    }
    name = name.toUpperCase(); sing = (sing||name).toUpperCase();
    if(!name) return null;
    return { name, sing };
  }
  function importGuruBulk(){
    const ta = document.getElementById('bulkGuruText');
    const text = (ta?.value||'').trim();
    if(!text){ notify('Tiada data untuk diimport.', 'warn'); return; }
    const lines = text.split(/\r?\n/);
    let added = 0, skipped = 0;
    const seen = new Set(TEACHERS.map(t=>t.name+"|"+(t.sing||'')));
    for(const ln of lines){
      const rec = parseGuruLine(ln);
      if(!rec) { skipped++; continue; }
      const key = rec.name+"|"+rec.sing;
      if(seen.has(key)) { skipped++; continue; }
      if(TEACHERS.some(t=>t.name===rec.name || (rec.sing && t.sing===rec.sing))){ skipped++; continue; }
      TEACHERS.push(rec); seen.add(key); added++;
    }
    renderTeacherTable(); buildJadual(); paparRumusan(); saveState();
    notify(`Import siap. Ditambah: ${added}, diabaikan: ${skipped}.`, 'ok');
  }
  function exportGuruCSV(){
    const rows = [['NAMA','SING']].concat(TEACHERS.map(t=>[t.name, t.sing||'']));
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'guru.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ========== SUBJEK ==========
  function renderSubjects(){
    const tbl = document.getElementById('tblSubjects');
    if(!tbl) return;
    let html = '<thead><tr><th>#</th><th>NAMA SUBJEK</th><th class="col-sing">SING</th><th>TINDAKAN</th></tr></thead><tbody>';
    if(!Array.isArray(SUBJECTS_ALL) || SUBJECTS_ALL.length===0){
      html += '<tr><td colspan="4">— Tiada subjek —</td></tr>';
    } else {
      SUBJECTS_ALL.forEach((s,i)=>{
        const nm = (s.name||'').toUpperCase();
        const sg = (s.sing||'').toUpperCase();
        html += `<tr>
          <td>${i+1}</td>
          <td><input class="in-subj-name" data-idx="${i}" value="${nm}" style="text-transform:uppercase" /></td>
          <td class="col-sing"><input class="in-subj-sing" data-idx="${i}" value="${sg}" style="text-transform:uppercase; width:110px" /></td>
          <td><button type="button" class="btn" onclick="removeSubject(${i})">Padam</button></td>
        </tr>`;
      });
    }
    html += '</tbody>';
    tbl.innerHTML = html;
    tbl.querySelectorAll('.in-subj-name').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const i = parseInt(inp.dataset.idx,10);
        if(!Number.isFinite(i) || i<0 || i>=SUBJECTS_ALL.length) return;
        SUBJECTS_ALL[i].name = (inp.value||'').trim().toUpperCase();
        saveState(); buildJadual();
      });
    });
    tbl.querySelectorAll('.in-subj-sing').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const i = parseInt(inp.dataset.idx,10);
        if(!Number.isFinite(i) || i<0 || i>=SUBJECTS_ALL.length) return;
        SUBJECTS_ALL[i].sing = (inp.value||'').trim().toUpperCase();
        saveState(); buildJadual();
      });
    });
  }
  function addSubject(){
    const nInp = document.getElementById('subjNama');
    const sInp = document.getElementById('subjSing');
    const nama = (nInp.value||'').trim().toUpperCase();
    const sing = (sInp.value||'').trim().toUpperCase();
    if(!nama){ notify('Sila masukkan nama subjek.', 'warn'); return; }
    const exists = SUBJECTS_ALL.some(s => s.name===nama || s.sing===sing);
    if(exists){ notify('Nama atau singkatan telah wujud.', 'warn'); return; }
    SUBJECTS_ALL.push({ name: nama, sing: sing || nama });
    nInp.value = ''; sInp.value = '';
    renderSubjects(); buildJadual(); saveState();
  }
  function removeSubject(idx){
    if(idx > -1 && idx < SUBJECTS_ALL.length){
      SUBJECTS_ALL.splice(idx,1);
      renderSubjects(); buildJadual(); saveState();
    }
  }

  // ========== JADUAL & RUMUSAN ==========
  function ensureRow(tingkatan, kelas, defaults){
    let rec = data.find(d => d.kelas === kelas && d.tingkatan === tingkatan);
    if(!rec){
      rec = { tingkatan, kelas, masa: defaults?.masa ?? 5, subjek: defaults?.subjek ?? "BI", guru: defaults?.guru ?? "", confirmed: false };
      data.push(rec);
    }
    if(typeof rec.confirmed !== 'boolean') rec.confirmed = false;
    return rec;
  }
  function buildJadual(){
    const tbl = document.getElementById("jadualSubjekUtama");
    if(!tbl) return;
    let html = `<thead>
      <tr><th colspan="5" class="header-utama">SUBJEK UTAMA</th></tr>
      <tr class="subhead-utama">
        <th>CLASS</th><th>BIL WAK</th><th>NAMA SUBJEK</th><th>NAMA GURU</th><th>TINDAKAN</th>
      </tr>
    </thead><tbody>`;
    TINGKATAN_ORDER.forEach(ting => {
      html += `<tr class="tingkatan-row"><td colspan="5">TINGKATAN ${ting}</td></tr>`;
      const classesForTing = (ting === 'PERALIHAN') ? PERALIHAN_CODES : CLASS_CODES;
      classesForTing.forEach(code => {
        const kelas = code;
        const rec = ensureRow(ting, kelas, { masa:5, subjek:"BI", guru:"" });
        const masaOpts = Array.from({length:10}, (_,i)=>i+1).map(v => `<option value="${v}" ${v===rec.masa ? "selected" : ""}>${v}</option>`).join("");
        let foundSub = false;
        let subjekOpts = `<option value=""></option>` + SUBJECTS_ALL.map(s => {
          const sel = (s.sing === rec.subjek);
          if(sel) foundSub = true;
          return `<option value="${s.sing}" ${sel ? 'selected' : ''}>${s.name}</option>`;
        }).join("");
        if(rec.subjek && !foundSub){
          subjekOpts = `<option value="${rec.subjek}" selected>(${rec.subjek})</option>` + subjekOpts;
        }
        const namesSet = new Set(TEACHERS.map(x=>x.name));
        let guruOpts = `<option value=""></option>`;
        guruOpts += TEACHERS.map(t => {
          const val = t.name;
          const label = t.sing || t.name;
          const sel = (val === rec.guru) ? 'selected' : '';
          return `<option value="${val}" ${sel}>${label}</option>`;
        }).join("");
        if(rec.guru && !namesSet.has(rec.guru)){
          guruOpts = `<option value="${rec.guru}" selected>${rec.guru}</option>` + guruOpts;
        }
        const disabled = rec.confirmed ? 'disabled' : '';
        html += `<tr>
          <td>${kelas}</td>
          <td><select class="inp-masa" data-ting="${ting}" data-kelas="${kelas}">${masaOpts}</select></td>
          <td><select class="inp-subjek" data-ting="${ting}" data-kelas="${kelas}">${subjekOpts}</select></td>
          <td><select class="inp-guru" data-ting="${ting}" data-kelas="${kelas}">${guruOpts}</select></td>
          <td><button type="button" class="btn btn-teruskan" data-ting="${ting}" data-kelas="${kelas}" ${disabled}>Teruskan</button></td>
        </tr>`;
      });
    });
    html += `</tbody>`;
    tbl.innerHTML = html;
    tbl.querySelectorAll('.inp-masa').forEach(sel => {
      sel.addEventListener('change', () => {
        const rec = ensureRow(sel.dataset.ting, sel.dataset.kelas);
        rec.masa = parseInt(sel.value,10) || 0; rec.confirmed = false;
        paparRumusan(); saveState();
      });
    });
    tbl.querySelectorAll('.inp-subjek').forEach(sel => {
      sel.addEventListener('change', () => {
        const rec = ensureRow(sel.dataset.ting, sel.dataset.kelas);
        rec.subjek = (sel.value||'').toUpperCase(); rec.confirmed = false;
        paparRumusan(); saveState();
      });
    });
    tbl.querySelectorAll('.inp-guru').forEach(sel => {
      sel.addEventListener('change', () => {
        const rec = ensureRow(sel.dataset.ting, sel.dataset.kelas);
        rec.guru = (sel.value||'').toUpperCase(); rec.confirmed = false;
        paparRumusan(); saveState();
      });
    });
    tbl.querySelectorAll('.btn-teruskan').forEach(btn => {
      btn.addEventListener('click', () => {
        const rec = ensureRow(btn.dataset.ting, btn.dataset.kelas);
        if(rec.confirmed) { notify('Data telah diisi.', 'warn'); return; }
        if(!rec.subjek || !rec.masa || !rec.kelas || !rec.tingkatan){ notify('Lengkapkan Subjek, Bil Waktu, Kelas, Tingkatan.', 'warn'); return; }
        if(!rec.guru){ notify('Sila pilih Nama Guru.', 'warn'); return; }
        const isDup = data.some(d => d !== rec && d.confirmed && d.tingkatan===rec.tingkatan && d.kelas===rec.kelas && d.subjek===rec.subjek && d.masa===rec.masa);
        if(isDup){ notify('Peringatan: kombinasi ini sudah diisi.', 'warn'); return; }
        rec.confirmed = true; saveState(); buildJadual(); paparRumusan(); notify('Disahkan.', 'ok');
      });
    });
  }
  function paparRumusan(){
    let group = {};
    data.forEach(item => {
      if(!item.guru || !item.confirmed) return;
      if(!group[item.guru]) group[item.guru] = { kelasSubjek: [], total: 0 };
      const tingLabel = (item.tingkatan === 'PERALIHAN') ? 'PERALIHAN' : `T${item.tingkatan}`;
      group[item.guru].kelasSubjek.push(`${tingLabel} ${item.kelas} (${item.subjek})`);
      group[item.guru].total += Number(item.masa)||0;
    });
    let html = '<table><thead><tr><th>Nama Guru</th><th>Subjek & Kelas</th><th>Jumlah Masa</th></tr></thead><tbody>';
    const keys = Object.keys(group);
    if(keys.length===0) html += '<tr><td colspan="3">— Tiada data disahkan —</td></tr>';
    else keys.forEach(guru=>{
      const t = TEACHERS.find(x => x.name === guru);
      const label = t ? (t.sing || t.name) : guru;
      html += `<tr><td>${label}</td><td>${group[guru].kelasSubjek.join(', ')}</td><td>${group[guru].total}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('output').innerHTML = html;
  }

  // ========== Boot ==========
  async function initializeApp(){
    loadState();
    if(!Array.isArray(SUBJECTS_ALL) || SUBJECTS_ALL.length === 0){
      SUBJECTS_ALL = SUBJECTS_DEFAULT.map(n=>({ name:n.toUpperCase(), sing:n.toUpperCase() }));
    }
    renderTeacherTable(); renderSubjects(); buildJadual(); paparRumusan();
    await fetchFromServer(); // cuba muat server (jika API_URL diset)
    try{
      const h = document.getElementById('mainHeaderTitle');
      if(h) h.textContent = document.title || h.textContent;
    }catch(e){}
  }
  initializeApp();

  // perlindungan: jika ada <a href=".../exec"> tak sengaja, block
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[href]');
    if(!a) return;
    if(/script\.google\.com\/.*\/exec/.test(a.href)){
      e.preventDefault();
      notify('Pautan Web App GAS disekat. Guna butang "Refresh" atau "Sync" untuk akses API.', 'warn');
    }
  });
</script>
</body>
</html>